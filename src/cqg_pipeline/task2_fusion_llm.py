"""\nTask 2 Fusion Module (LLM-based): Connect LLM knowledge with QA insights\n"""\n\nimport logging\nfrom typing import List, Dict\n\nlogger = logging.getLogger(__name__)\n\n\nclass FusionModuleLLM:\n    """Fuse LLM's internal knowledge with QA insights"""\n    \n    def __init__(self, llm_client):\n        """Initialize with LLM client"""\n        self.llm_client = llm_client\n        self.logger = logging.getLogger(__name__)\n    \n    def fuse_knowledge_and_data(\n        self,\n        cluster_action: str,\n        topics: List[str],\n        concepts: Dict[str, List[str]],\n        qa_pairs: List[Dict]\n    ) -> str:\n        """\n        Use LLM to fuse its knowledge about topics with actual QA data.\n        \n        Args:\n            cluster_action: Action label\n            topics: Extracted topics FROM QA PAIRS (more reliable)\n            concepts: LLM-selected concepts\n            qa_pairs: Real QA data\n        \n        Returns:\n            Fused understanding string\n        """\n        \n        topics_str = ', '.join(topics[:4])\n        \n        # Organize concepts\n        causal_str = ', '.join(concepts.get('causal', [])[:2])\n        impact_str = ', '.join(concepts.get('impact', [])[:2])\n        pattern_str = ', '.join(concepts.get('pattern', [])[:2])\n        \n        qa_summary = self._summarize_qas(qa_pairs)\n        \n        prompt = f"""You are performing deep causal reasoning about customer service workflows.\n\nCluster: {cluster_action}\nTopics: {topics_str}\n\nLLM Concepts:\n- Root Causes: {causal_str}\n- Impacts: {impact_str}\n- Patterns: {pattern_str}\n\nQ&A Evidence:\n{qa_summary}\n\nTASK:\n1. Produce a 3-step CAUSAL CHAIN explaining how the issue evolves.\n   Use format: A → B → C → Outcome\n\n   This chain must incorporate:\n   - Upstream technical or operational failures\n   - Hidden dependencies (billing backend, payment gateway delays)\n   - Customer actions or misunderstandings\n\n2. Produce 3 INSIGHTS that combine:\n   - Your domain knowledge (telecom/SaaS/billing)\n   - The Q&A evidence\n   - The concepts listed above\n\n3. Produce 2 INVESTIGATION DIRECTIONS:\n   - What analysts should look for in transcript data\n   - Which metrics/features should be examined\n\nReturn sections as:\nCAUSAL_CHAIN:\n- A → B → C → Outcome\n\nINSIGHTS:\n- ...\n- ...\n- ...\n\nINVESTIGATION:\n- ...\n- ...\n"""\n        \n        response = self.llm_client.generate_text(\n            prompt,\n            max_tokens=400,\n            temperature=0.2\n        )\n        \n        self.logger.info("Fused knowledge with QA data")\n        \n        return response\n    \n    def _summarize_qas(self, qa_pairs: List[Dict]) -> str:\n        """Summarize QA pairs for prompt"""\n        \n        summary = ""\n        for i, qa in enumerate(qa_pairs[:3], 1):\n            q = qa.get('query', '')\n            a = qa.get('response', '')\n            if len(a) > 150:\n                a = a[:150] + "..."\n            summary += f"Q{i}: {q}\\nA{i}: {a}\\n\\n"\n        \n        return summary if summary else "No QA data available"\n