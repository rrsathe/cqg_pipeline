"""\nTask 2 Selection Module (LLM-based): Select relevant concepts from LLM knowledge\n\nInput: topics (from QA pairs) + qa_pairs\nProcess: Ask LLM to identify causes, impacts, patterns\nOutput: Concepts organized by category\n"""\n\nimport logging\nimport re\nfrom typing import List, Dict\n\nlogger = logging.getLogger(__name__)\n\n\nclass SelectionModuleLLM:\n    """Use LLM's internal knowledge to select relevant concepts"""\n    \n    def __init__(self, llm_client):\n        """Initialize with LLM client"""\n        self.llm_client = llm_client\n        self.logger = logging.getLogger(__name__)\n    \n    def select_relevant_concepts(\n        self,\n        cluster_action: str,\n        topics: List[str],\n        qa_pairs: List[Dict]\n    ) -> Dict[str, List[str]]:\n        """\n        Use LLM to identify relevant concepts from its knowledge.\n        \n        Args:\n            cluster_action: Action label (e.g., 'refund_request')\n            topics: Extracted topics FROM QA PAIRS (now more reliable)\n            qa_pairs: QA pairs for this cluster\n        \n        Returns:\n            Dictionary with concepts by category:\n            {'causal': [...], 'impact': [...], 'pattern': [...]}\n        """\n        \n        if not topics:\n            self.logger.warning("No topics provided")\n            return {'causal': [], 'impact': [], 'pattern': []}\n        \n        # Build prompt\n        topics_str = ', '.join(topics[:5])\n        qa_summary = self._summarize_qas(qa_pairs)\n        \n        prompt = f"""You are an expert in telecom billing systems, subscription lifecycle operations, \ncustomer retention, refund processing, payment gateways, and contact center analytics.\n\nYour job is to analyze this cluster and identify DEEP, NON-OBVIOUS concepts that \ngo beyond the Q&A data, using your internal knowledge and reasoning.\n\nCluster Action: {cluster_action}\nKey Topics: {topics_str}\n\nHere is the Q&A evidence:\n{qa_summary}\n\nProvide:\n1. ROOT CAUSES (3 items):\n   - Systemic or upstream process issues\n   - Typical industry failure modes\n   - Operational bottlenecks not mentioned explicitly in the Q&A\n\n2. IMPACTS (3 items):\n   - Business or operational consequences\n   - Customer experience metrics\n   - Revenue or SLA implications\n\n3. PATTERNS / CONDITIONS (3 items):\n   - Common scenarios when the issue occurs\n   - Latent conditions (e.g., reconciliation periods, API failures)\n   - Related behaviors seen in telecom/customer support\n\nGROUNDING RULES:\n- Use world knowledge of telecom and SaaS systems.\n- Tie each concept back to the Q&A *implicitly or explicitly*.\n- Do NOT hallucinate specific numbers not in the Q&A.\n\nFormat EXACTLY:\n\nROOT_CAUSES:\n- ...\n- ...\n- ...\n\nIMPACTS:\n- ...\n- ...\n- ...\n\nPATTERNS:\n- ...\n- ...\n- ...\n"""\n        \n        # Call LLM\n        response = self.llm_client.generate_text(\n            prompt, \n            max_tokens=400, \n            temperature=0.2\n        )\n        \n        # Parse concepts\n        concepts = self._parse_concepts(response)\n        \n        self.logger.info(\n            f"Selected {sum(len(v) for v in concepts.values())} concepts"\n        )\n        \n        return concepts\n    \n    def _summarize_qas(self, qa_pairs: List[Dict]) -> str:\n        """Summarize QA pairs for prompt"""\n        \n        summary = ""\n        for i, qa in enumerate(qa_pairs[:3], 1):\n            q = qa.get('query', '')[:60]\n            a = qa.get('response', '')[:120]\n            summary += f"Q{i}: {q}\\nA{i}: {a}...\\n\\n"\n        \n        return summary if summary else "No QA data available"\n    \n    def _parse_concepts(self, response: str) -> Dict[str, List[str]]:\n        """Parse LLM response to extract concepts by category"""\n        \n        concepts = {'causal': [], 'impact': [], 'pattern': []}\n        \n        lines = response.split('\\n')\n        current_category = None\n        \n        for line in lines:\n            line = line.strip()\n            \n            # Detect category headers\n            if 'ROOT_CAUSE' in line.upper() or 'CAUSAL' in line.upper():\n                current_category = 'causal'\n                continue\n            elif 'IMPACT' in line.upper():\n                current_category = 'impact'\n                continue\n            elif 'SCENARIO' in line.upper() or 'PATTERN' in line.upper():\n                current_category = 'pattern'\n                continue\n            \n            # Extract concepts\n            if line and (line.startswith('-') or line.startswith('â€¢')):\n                concept = line[1:].strip()\n                if concept and len(concept) > 2 and current_category:\n                    concept = concept.rstrip('.,;:')\n                    concepts[current_category].append(concept)\n        \n        return concepts\n