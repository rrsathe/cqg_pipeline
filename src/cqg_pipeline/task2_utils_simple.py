"""\nTask 2 Utility Functions: Load QAs, link to clusters, export results\n"""\n\nimport json\nimport csv\nimport logging\nfrom typing import Dict, List, Optional\nfrom pathlib import Path\n\nlogger = logging.getLogger(__name__)\n\n\ndef load_qa_pairs(qa_file_path: str) -> List[Dict]:\n    """Load QA pairs from JSON file"""\n    \n    try:\n        with open(qa_file_path, 'r', encoding='utf-8') as f:\n            qa_pairs = json.load(f)\n        \n        if not isinstance(qa_pairs, list):\n            logger.warning("QA pairs should be a JSON list")\n            return []\n        \n        logger.info(f"✅ Loaded {len(qa_pairs)} QA pairs")\n        return qa_pairs\n    \n    except FileNotFoundError:\n        logger.error(f"❌ QA file not found: {qa_file_path}")\n        return []\n    except json.JSONDecodeError as e:\n        logger.error(f"❌ Error parsing JSON: {e}")\n        return []\n\n\ndef link_qas_to_clusters(\n    cluster_chars: Dict,\n    qa_pairs: List[Dict]\n) -> Dict[int, List[Dict]]:\n    """Link QA pairs to clusters by action_label matching"""\n    \n    cluster_qa_map = {}\n    \n    for cid, cluster_data in cluster_chars.items():\n        action_label = cluster_data.get('action_label', '').lower().strip()\n        key_phrases = [kp.lower().strip() for kp in cluster_data.get('key_phrases', [])]\n        \n        linked_qas = []\n        \n        for qa in qa_pairs:\n            query = qa.get('query', '').lower()\n            response = qa.get('response', '').lower()\n            \n            # Match by action_label in query\n            if action_label and action_label in query:\n                linked_qas.append(qa)\n            \n            # Match by key phrases in query\n            elif any(kp in query for kp in key_phrases if kp):\n                linked_qas.append(qa)\n            \n            # Match by action_label in response\n            elif action_label and action_label in response:\n                linked_qas.append(qa)\n        \n        # Remove duplicates\n        linked_qas = list({qa['query']: qa for qa in linked_qas}.values())\n        \n        cluster_qa_map[cid] = linked_qas\n    \n    return cluster_qa_map\n\n\ndef save_followups_csv(\n    enriched_clusters: Dict,\n    output_path: str\n) -> None:\n    """Save follow-up questions to CSV"""\n    \n    rows = []\n    \n    for cid, cluster_data in enriched_clusters.items():\n        action_label = cluster_data.get('action_label', 'unknown')\n        followups = cluster_data.get('deep_followups', [])\n        topics = ', '.join(cluster_data.get('topics', [])[:3])\n        \n        for i, followup_dict in enumerate(followups, 1):\n            if isinstance(followup_dict, dict):\n                question = followup_dict.get('question', '')\n                category = followup_dict.get('category', 'other')\n            else:\n                question = followup_dict\n                category = 'other'\n            \n            rows.append({\n                'cluster_id': cid,\n                'action_label': action_label,\n                'question_number': i,\n                'question': question,\n                'category': category,\n                'related_topics': topics\n            })\n    \n    output_file = Path(output_path)\n    output_file.parent.mkdir(parents=True, exist_ok=True)\n    \n    with open(output_path, 'w', newline='', encoding='utf-8') as f:\n        if rows:\n            fieldnames = [\n                'cluster_id',\n                'action_label',\n                'question_number',\n                'question',\n                'category',\n                'related_topics'\n            ]\n            writer = csv.DictWriter(f, fieldnames=fieldnames)\n            writer.writeheader()\n            writer.writerows(rows)\n            logger.info(f"✅ Saved {len(rows)} follow-up questions to {output_path}")\n